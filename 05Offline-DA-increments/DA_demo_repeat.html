
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>&lt;no title&gt; &#8212; Lorenz 1996 two time-scale model for learning machine learning</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/newlogo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Lorenz 1996 two time-scale model for learning machine learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Lorenz 1996 two time-scale model for learning machine learning
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Intro
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../01Intro/slides/presentation-model-setup.html">
   L96 analogs for this project
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Type of Parametrization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../02type-of-parametrization/estimating-gcm-parameters.html">
   1. Copy / pasting from gcm-parameterization-problem notebook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02type-of-parametrization/gcm-parameterization-problem.html">
   1. Introducing the need for GCM parameterizations
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data Assimilation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../03Data-Assimilation/DA_demo_L96.html">
   Data Assimilation demo in the Lorenz 96 (L96) two time-scale model
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Subgrid Patermetrization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../04Subgrid-parametrization-pytorch/Neural_network_for_Lorenz96.html">
   Using neural networks for L96 parameterization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../04Subgrid-parametrization-pytorch/gradient_decent.html">
   Neural networks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Different ML Models
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../06Different-ML-models/random_forest_parameterization.html">
   Starting with a single regression tree
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Implementation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../08-Implementation/Neural%20Network%20Advection%20FwdEuler.html">
   Using neural networks to parameterize advection in L96
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../08-Implementation/Neural%20Network%20Advection.html">
   Using neural networks to parameterize advection in L96
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/05Offline-DA-increments/DA_demo_repeat.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/m2lines/L96_demo"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/m2lines/L96_demo/issues/new?title=Issue%20on%20page%20%2F05Offline-DA-increments/DA_demo_repeat.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/m2lines/L96_demo/main?urlpath=tree/05Offline-DA-increments/DA_demo_repeat.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="simple visible nav section-nav flex-column">
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1><no title></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="simple visible nav section-nav flex-column">
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inspect</span>

<span class="kn">import</span> <span class="nn">DA_methods</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.tri</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">L96_model</span> <span class="kn">import</span> <span class="n">L96</span><span class="p">,</span> <span class="n">L96_eq1_xdot</span>
</pre></div>
</div>
</div>
</div>
<p>This notebook is a stripped-down copy of the notebook in <code class="docutils literal notranslate"><span class="pre">03Data-Assimilation</span></code> directory and altered the parameters of the Lorenz 1996 model to match those of Wilks, 2005.</p>
<ul class="simple">
<li><p>For the purposes of this illustration, we removed all the unused options and parameters in the DA algorithm.</p></li>
<li><p>The L96 model here uses K=8, J=32, F=18, as in Wilks, 2005.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For reproducibility</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">3210</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a function to represent the GCM, and many other convenience functions used within the DA algorithm</span>


<span class="k">def</span> <span class="nf">GCM</span><span class="p">(</span><span class="n">X0</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">time</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X0</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="n">X0</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">L96_eq1_xdot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">X</span><span class="p">))</span>

        <span class="n">hist</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">time</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hist</span><span class="p">,</span> <span class="n">time</span>


<span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A non-dimension coordinate from -1..+1 corresponding to k=0..K&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">K</span> <span class="o">-</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">get_dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">K</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">K</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>


<span class="c1"># Generate observation operator, assuming linearity and model space observations</span>
<span class="k">def</span> <span class="nf">ObsOp</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">i_t</span><span class="p">):</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="n">l_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nobs</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span>
    <span class="n">H</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">nobs</span><span class="p">),</span> <span class="n">l_obs</span><span class="p">[</span><span class="n">t_obs</span> <span class="o">==</span> <span class="n">i_t</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">H</span>


<span class="c1"># localize covariance matrix based on the Gaspari-Cohn function</span>
<span class="k">def</span> <span class="nf">cov_loc</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">get_dist</span><span class="p">)(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">gaspari_cohn</span><span class="p">)(</span><span class="n">dist</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">B</span> <span class="o">*</span> <span class="n">W</span><span class="p">,</span> <span class="n">W</span>


<span class="k">def</span> <span class="nf">gaspari_cohn</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">distance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">radius</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">distance</span> <span class="o">/</span> <span class="n">radius</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="o">-</span><span class="p">(</span><span class="n">ratio</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
                    <span class="o">+</span> <span class="n">ratio</span><span class="o">**</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">8</span>
                    <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span>
                    <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">ratio</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ratio</span><span class="o">**</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">12</span>
                    <span class="o">-</span> <span class="n">ratio</span><span class="o">**</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">8</span>
                    <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span>
                    <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">ratio</span>
                    <span class="o">+</span> <span class="mi">4</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">ratio</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">weight</span>


<span class="k">def</span> <span class="nf">find_obs</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
    <span class="n">t_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">t_obs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t_obs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">period</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">obs_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t_period</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">obs_period</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_period</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">l_obs</span><span class="p">[</span><span class="n">t_period</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">loc</span><span class="p">):</span>
            <span class="n">obs_period</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">t_period</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]][</span><span class="n">l_obs</span><span class="p">[</span><span class="n">t_period</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">loc</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">obs_period</span>


<span class="k">def</span> <span class="nf">running_ave</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">N1</span><span class="p">,</span> <span class="n">N2</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">N1</span><span class="p">,</span> <span class="n">N2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">X_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N1</span><span class="p">,</span> <span class="n">N2</span><span class="p">):</span>
        <span class="n">X_sum</span> <span class="o">=</span> <span class="n">X_sum</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X_sum</span> <span class="o">/</span> <span class="n">N</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Goldilocks settings</span>
<span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">K</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>  <span class="c1"># Dimension of L96 &quot;X&quot; variables</span>
    <span class="n">J</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>  <span class="c1"># Dimension of L96 &quot;Y&quot; variables</span>
    <span class="n">obs_freq</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># observation frequency (number of sampling intervals (si) per observation)</span>
    <span class="n">F_truth</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>  <span class="c1"># F for truth signal</span>
    <span class="n">F_fcst</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>  <span class="c1"># F for forecast (DA) model</span>
    <span class="n">GCM_param</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">),</span>  <span class="c1"># polynomial coefficicents for GCM parameterization</span>
    <span class="n">ns_da</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>  <span class="c1"># number of time samples for DA</span>
    <span class="n">ns</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>  <span class="c1"># number of time samples for truth signal</span>
    <span class="n">ns_spinup</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>  <span class="c1"># number of time samples for spin up</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>  <span class="c1"># model timestep</span>
    <span class="n">si</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>  <span class="c1"># truth sampling interval</span>
    <span class="n">B_loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># spatial localization radius for DA</span>
    <span class="n">DA</span><span class="o">=</span><span class="s2">&quot;EnKF&quot;</span><span class="p">,</span>  <span class="c1"># DA method</span>
    <span class="n">nens</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="c1"># number of ensemble members for DA</span>
    <span class="n">inflate_opt</span><span class="o">=</span><span class="s2">&quot;relaxation&quot;</span><span class="p">,</span>  <span class="c1"># method for DA model covariance inflation</span>
    <span class="n">inflate_factor</span><span class="o">=</span><span class="mf">0.86</span><span class="p">,</span>  <span class="c1"># inflation factor</span>
    <span class="n">obs_density</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># fraction of spatial gridpoints where observations are collected</span>
    <span class="n">DA_freq</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># assimilation frequency (number of sampling intervals (si) per assimilation step)</span>
    <span class="n">obs_sigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># observational error standard deviation</span>
    <span class="n">initial_spread</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Initial spread added to initial conditions</span>
<span class="p">)</span>

<span class="c1"># Uncomment blocks below to perturb the above settings</span>

<span class="c1"># # Less certain observations</span>
<span class="c1"># config[&#39;obs_sigma&#39;] = 1.0</span>
<span class="c1"># config[&#39;initial_spread&#39;] = 1.0</span>
<span class="c1"># config[&#39;inflate_factor&#39;] = 0.5</span>

<span class="c1"># # Less frequent observations</span>
<span class="c1"># config[&#39;obs_freq&#39;] = 50</span>
<span class="c1"># config[&#39;DA_freq&#39;] = 50</span>
<span class="c1"># config[&#39;inflate_factor&#39;] = 0.4</span>

<span class="c1"># # Very infrequent observations</span>
<span class="c1"># config[&#39;obs_freq&#39;] = 200</span>
<span class="c1"># config[&#39;DA_freq&#39;] = 200</span>
<span class="c1"># config[&#39;inflate_factor&#39;] = 0.5</span>

<span class="c1"># # More frequent observations</span>
<span class="c1"># config[&#39;obs_freq&#39;] = 5</span>
<span class="c1"># config[&#39;DA_freq&#39;] = 5</span>
<span class="c1"># config[&#39;inflate_factor&#39;] = 0.9</span>

<span class="c1"># # Very frequent observations</span>
<span class="c1"># config[&#39;obs_freq&#39;] = 1</span>
<span class="c1"># config[&#39;DA_freq&#39;] = 1</span>
<span class="c1"># config[&#39;inflate_factor&#39;] = 0.98</span>

<span class="c1"># # Very frequent observations but less accurate</span>
<span class="c1"># config[&#39;obs_freq&#39;] = 1</span>
<span class="c1"># config[&#39;DA_freq&#39;] = 1</span>
<span class="c1"># config[&#39;obs_sigma&#39;] = 1.0</span>
<span class="c1"># config[&#39;initial_spread&#39;] = 1.0</span>
<span class="c1"># config[&#39;inflate_factor&#39;] = 0.9</span>

<span class="c1"># # Different time-scale</span>
<span class="c1"># config[&#39;F_fcst&#39;] = 16</span>
</pre></div>
</div>
</div>
</div>
<p>The ‘real world” is the Lorenz ‘96 model:</p>
<div class="amsmath math notranslate nohighlight" id="equation-215f308a-bb2f-49c0-bd3a-be6b053e4ebe">
<span class="eqno">()<a class="headerlink" href="#equation-215f308a-bb2f-49c0-bd3a-be6b053e4ebe" title="Permalink to this equation">¶</a></span>\[\begin{align}
\frac{d}{dt} X_k
&amp;= - X_{k-1} \left( X_{k-2} - X_{k+1} \right) - X_k + F - \left( \frac{hc}{b} \right) \sum_{j=0}^{J-1} Y_{j,k}
\\
\frac{d}{dt} Y_{j,k}
&amp;= - cbY_{j+1,k} \left( Y_{j+2,k} - X_{j-1,k} \right) - c Y_{j,k} + \frac{hc}{b} X_k
\end{align}\]</div>
<p>The cell below spins-up a state and then records a series of $X$ and $Y$ at time $t$ in arrays <code class="docutils literal notranslate"><span class="pre">X_truth</span></code>, <code class="docutils literal notranslate"><span class="pre">Y_truth</span></code> and <code class="docutils literal notranslate"><span class="pre">t_truth</span></code> respectively. The initial state $X(t=0$ is recorded in <code class="docutils literal notranslate"><span class="pre">X_init</span></code> (and equal to <code class="docutils literal notranslate"><span class="pre">X_truth[0]</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the &quot;truth&quot; 2-scale L96 model and generate initial conditions from a short spinup</span>
<span class="n">M_truth</span> <span class="o">=</span> <span class="n">L96</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;J&quot;</span><span class="p">],</span> <span class="n">F</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;F_truth&quot;</span><span class="p">],</span> <span class="n">dt</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">])</span>
<span class="n">M_truth</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">])),</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">j</span><span class="p">)</span>
<span class="n">X_init</span><span class="p">,</span> <span class="n">Y_init</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;si&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;si&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_spinup&quot;</span><span class="p">])</span>
<span class="n">X_init</span><span class="p">,</span> <span class="n">Y_init</span> <span class="o">=</span> <span class="n">X_init</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Y_init</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">M_truth</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">X_init</span><span class="p">,</span> <span class="n">Y_init</span><span class="p">)</span>

<span class="c1"># Run L96 to generate the &quot;truth&quot;</span>
<span class="n">X_truth</span><span class="p">,</span> <span class="n">Y_truth</span><span class="p">,</span> <span class="n">t_truth</span> <span class="o">=</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;si&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;si&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns&quot;</span><span class="p">])</span>

<span class="k">del</span> <span class="n">Y_init</span>  <span class="c1"># Not used below</span>
</pre></div>
</div>
</div>
</div>
<p>Now we create some “observations” of the “real world” by sampling at <code class="docutils literal notranslate"><span class="pre">obs_freq</span></code> intervals and adding some noise (observational error). <code class="docutils literal notranslate"><span class="pre">X_obs</span></code> are the observations at <code class="docutils literal notranslate"><span class="pre">k=l_obs</span></code> positions and <code class="docutils literal notranslate"><span class="pre">t=t_truth[t_obs]</span></code> times. Note that <code class="docutils literal notranslate"><span class="pre">t_obs</span></code> is an index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample the &quot;truth&quot; to generate observations at certain times (t_obs) and locations (l_obs)</span>
<span class="n">t_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_freq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_freq&quot;</span><span class="p">]),</span>
    <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_density&quot;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">l_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">l_obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_density&quot;</span><span class="p">]),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="n">X_obs</span> <span class="o">=</span> <span class="n">X_truth</span><span class="p">[</span><span class="n">t_obs</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">]</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_sigma&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">l_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculated observation covariance matrix, assuming independent observations</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_sigma&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_density&quot;</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_truth</span><span class="p">[:],</span> <span class="n">X_truth</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;truth&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="n">find_obs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">X_obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">,</span> <span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">t_obs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time t&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;X(t)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Observations at k=0&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/DA_demo_repeat_8_0.png" src="../_images/DA_demo_repeat_8_0.png" />
</div>
</div>
<p>We run the model in forward mode for 5000 steps to calculate the background covariance. The model is the “GCM” function defined above which integrates forward</p>
<div class="amsmath math notranslate nohighlight" id="equation-2a91c4ae-66d1-46ca-9e72-a95d46b35b8f">
<span class="eqno">()<a class="headerlink" href="#equation-2a91c4ae-66d1-46ca-9e72-a95d46b35b8f" title="Permalink to this equation">¶</a></span>\[\begin{align}
\frac{d}{dt} X_k
&amp;= - X_{k-1} \left( X_{k-2} - X_{k+1} \right) - X_k + F
\end{align}\]</div>
<p>The absence of the coupling term to the $Y$ equations makes this a model with “missing physics” that we hope the Ensemble Kalman Filter will correct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate climatological background covariance for 1-scale L96 model</span>
<span class="n">X1_clim</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">GCM</span><span class="p">(</span><span class="n">X_init</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;F_fcst&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">],</span> <span class="mi">5000</span><span class="p">)</span>
<span class="n">B_clim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X1_clim</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="k">del</span> <span class="n">X1_clim</span>

<span class="c1"># load pre-calculated climatological background covariance matrix from a long simulation</span>
<span class="c1"># B_clim1=np.load(&#39;B_clim_L96s.npy&#39;)</span>
<span class="n">B_loc</span><span class="p">,</span> <span class="n">W_clim</span> <span class="o">=</span> <span class="n">cov_loc</span><span class="p">(</span><span class="n">B_clim1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;B_loc&quot;</span><span class="p">])</span>

<span class="n">B_corr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B_clim1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B_clim1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B_clim1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">B_corr1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B_clim1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B_clim1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_clim1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">B_corr1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Background correlation matrix 1-scale L96&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">B_loc</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;B_loc&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">W_clim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;W_clim&quot;</span><span class="p">)</span>

<span class="k">del</span> <span class="n">B_loc</span>  <span class="c1"># not used below</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/DA_demo_repeat_10_0.png" src="../_images/DA_demo_repeat_10_0.png" />
</div>
</div>
<p>This is the actual DA algorithm. It steps through segments of time (“DA cycles”), launching an ensemble of short forecasts from the posterior estimate of the preceding segment, each perturbed by noise in their initial condition (inflation).</p>
<p>Each ensemble trajectory is stored in <code class="docutils literal notranslate"><span class="pre">ensX</span></code>. The increment added to correct the prior is in <code class="docutils literal notranslate"><span class="pre">X_inc</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up array to store DA increments</span>
<span class="n">X_inc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]),</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;nens&quot;</span><span class="p">])</span>
<span class="p">)</span>
<span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;3DVar&quot;</span><span class="p">:</span>
    <span class="n">X_inc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">X_inc</span><span class="p">)</span>
<span class="n">t_DA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]))</span>

<span class="c1"># initialize ensemble with perturbations</span>
<span class="n">i_t</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ensX</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">X_init</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;nens&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;initial_spread&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">X_post</span> <span class="o">=</span> <span class="n">ensX</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

<span class="n">W</span> <span class="o">=</span> <span class="n">W_clim</span>

<span class="c1"># DA cycles</span>
<span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">):</span>

    <span class="c1"># set up array to store model forecast for each DA cycle</span>
    <span class="n">ensX_fcst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;nens&quot;</span><span class="p">]))</span>

    <span class="c1"># model forecast for next DA cycle</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nens&quot;</span><span class="p">]):</span>
        <span class="n">ensX_fcst</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">GCM</span><span class="p">(</span>
            <span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="n">n</span><span class="p">],</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;F_fcst&quot;</span><span class="p">],</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">],</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">],</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;GCM_param&quot;</span><span class="p">],</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i_t</span> <span class="o">=</span> <span class="n">i_t</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]</span>

    <span class="c1"># get prior/background from the forecast</span>
    <span class="n">X_prior</span> <span class="o">=</span> <span class="n">ensX_fcst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># get prior from model integration</span>

    <span class="c1"># call DA</span>
    <span class="n">t_DA</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_truth</span><span class="p">[</span><span class="n">i_t</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;EnKF&quot;</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">ObsOp</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="n">l_obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">i_t</span><span class="p">)</span>
        <span class="c1"># augment state vector with parameters when doing parameter estimation</span>
        <span class="n">B_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X_prior</span><span class="p">)</span>
        <span class="n">B_ens_loc</span> <span class="o">=</span> <span class="n">B_ens</span> <span class="o">*</span> <span class="n">W</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]]</span>
        <span class="n">X_post</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">EnKF</span><span class="p">(</span><span class="n">X_prior</span><span class="p">,</span> <span class="n">X_obs</span><span class="p">[</span><span class="n">t_obs</span> <span class="o">==</span> <span class="n">i_t</span><span class="p">],</span> <span class="n">H</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">B_ens_loc</span><span class="p">)</span>
        <span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">ens_inflate</span><span class="p">(</span>
            <span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="p">:],</span>
            <span class="n">X_prior</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="p">:],</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inflate_opt&quot;</span><span class="p">],</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inflate_factor&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">X_post</span> <span class="o">=</span> <span class="n">X_prior</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">X_inc</span><span class="p">[</span><span class="n">cycle</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="o">...</span><span class="p">])</span> <span class="o">-</span> <span class="n">X_prior</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># get current increments</span>
        <span class="c1"># get posterior info about the estimated parameters</span>

    <span class="c1"># reset initial conditions for next DA cycle</span>
    <span class="n">ensX_fcst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">],</span> <span class="p">:]</span>
    <span class="n">ensX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ensX</span><span class="p">,</span> <span class="n">ensX_fcst</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">meanX</span></code> is the ensemble mean forecast, averaging over all the ensemble members. It has discontinuities due to the increment add between each DA segment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># post processing and visualization</span>
<span class="n">meanX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ensX</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">clim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meanX</span> <span class="o">-</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="n">meanX</span> <span class="o">-</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;X - X_truth&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">meanX</span> <span class="o">-</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ensX</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Spread&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_sigma&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Obs error&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RMSE (X - X_truth)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">meanX</span> <span class="o">-</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">X_inc_ave</span> <span class="o">=</span> <span class="n">X_inc</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;si&quot;</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">X_inc_ave</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Inc&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">running_ave</span><span class="p">(</span><span class="n">X_inc_ave</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">7</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Inc Ave&quot;</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;F_fcst&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;F_truth&quot;</span><span class="p">]),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;F_bias&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">X_inc</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;si&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
    <span class="s2">&quot;k:&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ave Inc&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Increments&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

<span class="c1"># X_inc_ave=(X_inc/config[&#39;DA_freq&#39;]/config[&#39;si&#39;]).mean(axis=(1,2)).\</span>
<span class="c1">#         reshape(int(config[&#39;ns_da&#39;]/ann_period),int(ann_period/config[&#39;DA_freq&#39;])).mean(axis=0)</span>
<span class="c1"># axes[0,2].plot(np.arange(ann_period/config[&#39;DA_freq&#39;]),X_inc_ave,label=&#39;Inc&#39;)</span>
<span class="c1"># axes[0,2].plot(np.arange(ann_period/config[&#39;DA_freq&#39;]),running_ave(X_inc_ave,10),label=&#39;Inc Ave&#39;);</span>
<span class="c1"># axes[0,2].plot(np.arange(0,ann_period/config[&#39;DA_freq&#39;],mon_period/config[&#39;DA_freq&#39;]),</span>
<span class="c1">#                -2*np.sin(2*np.pi*np.arange(mon_per_ann)/mon_per_ann),label=&#39;F_bias&#39;)</span>
<span class="c1"># axes[0,2].legend()</span>
<span class="c1"># axes[0,2].set_xlabel(&#39;&quot;annual cycle&quot;&#39;); axes[0,2].set_title(&#39;Increments&#39;);</span>
<span class="c1"># axes[0,2].grid(which=&#39;both&#39;,linestyle=&#39;--&#39;)</span>

<span class="n">plot_start</span><span class="p">,</span> <span class="n">plot_end</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">800</span>
<span class="n">plot_start_DA</span><span class="p">,</span> <span class="n">plot_end_DA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">plot_start</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span>
    <span class="n">plot_end</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plot_x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="n">plot_start</span><span class="p">:</span><span class="n">plot_end</span><span class="p">],</span> <span class="n">X_truth</span><span class="p">[</span><span class="n">plot_start</span><span class="p">:</span><span class="n">plot_end</span><span class="p">,</span> <span class="n">plot_x</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;truth&quot;</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="n">plot_start</span><span class="p">:</span><span class="n">plot_end</span><span class="p">],</span> <span class="n">meanX</span><span class="p">[</span><span class="n">plot_start</span><span class="p">:</span><span class="n">plot_end</span><span class="p">,</span> <span class="n">plot_x</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast&quot;</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">t_DA</span><span class="p">[</span><span class="n">plot_start_DA</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">plot_end_DA</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">find_obs</span><span class="p">(</span><span class="n">plot_x</span><span class="p">,</span> <span class="n">X_obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">,</span> <span class="p">[</span><span class="n">plot_start</span><span class="p">,</span> <span class="n">plot_end</span><span class="p">]),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;k=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">plot_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; truth and forecast&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="mf">0.1</span><span class="p">,</span>
    <span class="mf">0.1</span><span class="p">,</span>
    <span class="s2">&quot;RMSE=</span><span class="si">{:3f}</span><span class="se">\n</span><span class="s2">Spread=</span><span class="si">{:3f}</span><span class="se">\n</span><span class="s2">GCM param=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">DA=</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">DA_freq=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">B_loc=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">inflation=</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">obs_density=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">obs_sigma=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">obs_freq=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">meanX</span> <span class="o">-</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ns_da&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ensX</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;GCM_param&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;nens&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;B_loc&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inflate_opt&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inflate_factor&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_density&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_sigma&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;obs_freq&quot;</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/DA_demo_repeat_14_0.png" src="../_images/DA_demo_repeat_14_0.png" />
</div>
</div>
<p>Converting the increment <code class="docutils literal notranslate"><span class="pre">X_inc</span></code> into a tendency, we can examine the relationship between the $\dot{X}$ due to the missing physics and the state of the model at the beginning of each DA segment. If we are properly correcting the absence of the coupling term then this structure should look like the parameterization of the coupling term, as done in Wilks, 2005.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X_inc_ave</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-7</span>

<span class="n">x_input</span> <span class="o">=</span> <span class="n">ensX</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span>
    <span class="n">jj</span>
<span class="p">]</span>  <span class="c1"># The offset by DA_freq looks at the previous posterior</span>
<span class="n">x_input</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
    <span class="n">x_input</span> <span class="o">+</span> <span class="n">ensX</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">jj</span><span class="p">]</span>
<span class="p">)</span>  <span class="c1"># Mid-point of trajectory</span>
<span class="n">xinc_output</span> <span class="o">=</span> <span class="n">X_inc_ave</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">jj</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x_input</span><span class="p">,</span> <span class="n">xinc_output</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">p18</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.000707</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0130</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0190</span><span class="p">,</span> <span class="mf">1.59</span><span class="p">,</span> <span class="mf">0.275</span><span class="p">]</span>  <span class="c1"># Polynomial from Wilks, 2005</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;All time, all individial k, and all ensemble members&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_input</span><span class="p">,</span> <span class="n">xinc_output</span><span class="p">,</span> <span class="s2">&quot;k.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p18</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$P_4(X_k)$ - Wilks, 2005&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$P_4(X_k)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Ensemble member $X_i(k,t)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Ensemble member increment $\dot</span><span class="si">{X}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span>
    <span class="n">x_input</span><span class="p">,</span> <span class="n">xinc_output</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p18</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$P_4(X_k)$ - Wilks, 2005&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$P_4(X_k)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Ensemble member $X_i(k,t)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Ensemble member increment $\dot</span><span class="si">{X}</span><span class="s2">$&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/DA_demo_repeat_16_0.png" src="../_images/DA_demo_repeat_16_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X_inc_ave</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-7</span>

<span class="n">x_input</span> <span class="o">=</span> <span class="n">meanX</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span>
    <span class="n">jj</span>
<span class="p">]</span>  <span class="c1"># The offset by DA_freq looks at the previous posterior</span>
<span class="n">x_input</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_input</span> <span class="o">+</span> <span class="n">meanX</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">jj</span><span class="p">])</span>  <span class="c1"># Mid-point of trajectory</span>
<span class="n">xinc_output</span> <span class="o">=</span> <span class="n">X_inc_ave</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">jj</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x_input</span><span class="p">,</span> <span class="n">xinc_output</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">p18</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.000707</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0130</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0190</span><span class="p">,</span> <span class="mf">1.59</span><span class="p">,</span> <span class="mf">0.275</span><span class="p">]</span>  <span class="c1"># Polynomial from Wilks, 2005</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;All time, all individial k, mean over ensemble members&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_input</span><span class="p">,</span> <span class="n">xinc_output</span><span class="p">,</span> <span class="s2">&quot;k.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p18</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$P_4(X_k)$ - Wilks, 2005&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$P_4(X_k)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Ensemble member $X_i(k,t)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Ensemble member increment $\dot</span><span class="si">{X}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span>
    <span class="n">x_input</span><span class="p">,</span> <span class="n">xinc_output</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p18</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$P_4(X_k)$ - Wilks, 2005&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$P_4(X_k)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Ensemble member $X_i(k,t)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Ensemble member increment $\dot</span><span class="si">{X}</span><span class="s2">$&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/DA_demo_repeat_17_0.png" src="../_images/DA_demo_repeat_17_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xl</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">si</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]</span>

<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_obs</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># True if observation at time t_obs for column k</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Ensemble mean, k = </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_truth</span><span class="p">,</span> <span class="n">X_truth</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Truth&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">,</span>
    <span class="n">meanX</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">ensX</span><span class="p">[:,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">meanX</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">ensX</span><span class="p">[:,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ensemble spread&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_truth</span><span class="p">,</span> <span class="n">meanX</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ensemble mean forecast&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="n">meanX</span><span class="p">[</span><span class="n">si</span><span class="p">::</span><span class="n">si</span><span class="p">,</span> <span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">-</span> <span class="n">X_inc</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span>
    <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ensemble mean prior&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_truth</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">meanX</span><span class="p">[</span><span class="n">si</span><span class="p">::</span><span class="n">si</span><span class="p">,</span> <span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ensemble mean post&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time, t&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$X(t)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/DA_demo_repeat_18_0.png" src="../_images/DA_demo_repeat_18_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xl</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">e</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">si</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;DA_freq&quot;</span><span class="p">]</span>

<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_obs</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># True if observation at time t_obs for column k</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Ensemble member </span><span class="si">%i</span><span class="s2"> , k = </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_truth</span><span class="p">,</span> <span class="n">X_truth</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Truth&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_truth</span><span class="p">,</span> <span class="n">ensX</span><span class="p">[:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ensemble member forecast&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="n">ensX</span><span class="p">[</span><span class="n">si</span><span class="p">::</span><span class="n">si</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">-</span> <span class="n">X_inc</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span>
    <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ensemble member prior&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_truth</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">ensX</span><span class="p">[</span><span class="n">si</span><span class="p">::</span><span class="n">si</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">e</span><span class="p">][</span><span class="n">l</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ensemble member post&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time, t&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$X(t)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/DA_demo_repeat_19_0.png" src="../_images/DA_demo_repeat_19_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save data for other notebooks to read</span>
<span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span>
    <span class="s2">&quot;increments.npz&quot;</span><span class="p">,</span>
    <span class="n">ensX</span><span class="o">=</span><span class="n">ensX</span><span class="p">,</span>
    <span class="n">X_inc</span><span class="o">=</span><span class="n">X_inc</span><span class="p">,</span>
    <span class="n">t_obs</span><span class="o">=</span><span class="n">t_obs</span><span class="p">,</span>
    <span class="n">l_obs</span><span class="o">=</span><span class="n">l_obs</span><span class="p">,</span>
    <span class="n">t_inc</span><span class="o">=</span><span class="n">t_truth</span><span class="p">[</span><span class="n">t_obs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="n">X_truth</span><span class="o">=</span><span class="n">X_truth</span><span class="p">,</span>
    <span class="n">Y_truth</span><span class="o">=</span><span class="n">Y_truth</span><span class="p">,</span>
    <span class="n">t_truth</span><span class="o">=</span><span class="n">t_truth</span><span class="p">,</span>
    <span class="n">X_obs</span><span class="o">=</span><span class="n">X_obs</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./05Offline-DA-increments"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By The M2LinES Community<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>